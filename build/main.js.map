{
  "version": 3,
  "sources": ["../src/main.ts"],
  "sourcesContent": ["/*\n * Created with @iobroker/create-adapter v2.3.0\n */\n\nimport * as utils from '@iobroker/adapter-core';\nimport ModbusRTU from 'modbus-serial';\nimport * as protocoll from '/home/pi/ioBroker.wr-goodwe-mt/src/protocol.json';\nimport { inherits } from 'util';\n\nclass WrGoodweMt extends utils.Adapter {\n    private client = new ModbusRTU();\n    private ids: number[] = [];\n    private iList = new Map<number,string>();\n\n    private sleep = (ms:any) => new Promise(resolve => setTimeout(resolve, ms));\n\n    public constructor(options: Partial<utils.AdapterOptions> = {}) {\n        super({\n            ...options,\n            name: 'wr-goodwe-mt',\n        });\n        this.on('ready', this.onReady.bind(this));\n        this.on('stateChange', this.onStateChange.bind(this));\n        this.on('unload', this.onUnload.bind(this));\n    }\n\n    private async onReady(): Promise<void> {\n        this.ids = new Array(this.config.endID-this.config.startID+1);\n        this.log.debug(\"Start ID:\" + String(this.config.startID));\n        this.log.debug(\"End ID:\" + String(this.config.endID));\n        this.setState('info.connection', false, true);\n\n        this.client.connectRTUBuffered(this.config.Interface, { baudRate: 9600 , parity: 'none', dataBits: 8, stopBits: 1, });\n        await this.client.setTimeout(1000);\n        await this.sleep(2000);\n        for(var i = this.config.startID; i <=this.config.endID; i++){\n            this.ids[i-this.config.startID] = i;\n            try{\n                await this.client.setID(i);\n                const val =  await this.client.readHoldingRegisters(512, 7);\n                this.log.error(String(val.buffer));\n                this.iList.set(i,String(val.buffer));\n                if(val.buffer!=undefined){\n                    await this.setObjectNotExistsAsync(String(this.iList.get(i)), {\n                        type: 'channel',\n                        common: {\n                        name: String(this.iList.get(i)),\n                        },\n                        native: {},\n                    });\n            }\n            } catch(e: any){\n                this.log.error(\"ID: \"+i+\": \"+String(e.message));\n            }\n        }\n        await this.startComm();\n    }\n\n    private conversionUint32(arr: number[]): number{\n        let uint8bytes = Uint8Array.from(arr);\n        let dataview = new DataView(uint8bytes.buffer);\n        return  dataview.getUint32(0);\n    }\n\n    private conversionInt32(arr: number[]): number{\n        let uint8bytes = Uint8Array.from(arr);\n        let dataview = new DataView(uint8bytes.buffer);\n        return  dataview.getInt32(0);\n    }\n\n    private async read(register: number [], adressPosition: number):Promise<number>{\n        try{\n            var puffer: number [] = [];\n            var sn: Uint8Array [] = [];\n\n            for(var i = 0; i < register.length; i++){\n                const val =  await this.client.readHoldingRegisters(register[i], 1);\n                switch(protocoll.Read.Adresses[adressPosition].Datatype){\n                    case 1: puffer[i] = Buffer.from([val.buffer[0],val.buffer[1]]).readUint16BE(0); break;\n                    case 2: puffer[i] = Buffer.from([val.buffer[0],val.buffer[1]]).readInt16BE(0);break;\n                    case 3: puffer[2*i] =  Buffer.from([(val.buffer[0])]).readUInt8(); puffer[2*i+1] =  Buffer.from([(val.buffer[1])]).readUInt8(); break; \n                    case 4: puffer[2*i] =  Buffer.from([(val.buffer[0])]).readUInt8(); puffer[2*i+1] =  Buffer.from([(val.buffer[1])]).readUInt8(); break;\n                    default: this.log.error(\"Not found\"); break;\n                }\n            }\n            switch(protocoll.Read.Adresses[adressPosition].Datatype){\n                case 1: return puffer[0];\n                case 2: return puffer[0];\n                case 3: return this.conversionUint32(puffer); \n                case 4: return this.conversionInt32(puffer);\n                default: this.log.error(\"Not found\"); return -1000;\n            }            \n        }\n        catch(e: any){\n            this.log.error(String(e.message));\n            return -1;\n        }\n    }\n\n    private async startComm():Promise<void>{\n        const metersIdList = this.ids;\n\n        const getMeterValue = async (id:number) => {\n\n            for(let i = 1; i < protocoll.Read.Adresses.length; i++){\n                //this.log.debug('WR'+id+'.'+protocoll.Read.Adresses[i].Name);\n                if(this.iList.get(id)!= undefined){\n                    await this.setObjectNotExistsAsync(this.iList.get(id)+'.'+protocoll.Read.Adresses[i].Name, {\n                        type: 'state',\n                        common: {\n                            name: protocoll.Read.Adresses[i].Name,\n                            type: 'number',\n                            role: 'indicator',\n                            read: true,\n                            unit: protocoll.Read.Adresses[i].Unit,\n                            write: true,\n                        },\n                        native: {},\n                    });\n                    await this.client.setID(id);\n                    const val = await this.read(protocoll.Read.Adresses[i].Register, i);\n                    await this.setState(String(this.iList.get(id))+'.'+protocoll.Read.Adresses[i].Name, val*protocoll.Read.Adresses[i].Factor);\n                }\n            }\n            return 1;\n        }\n\n        const getMetersValue = async (meters:any) => {\n            try{\n                if(this.client.isOpen){\n                    this.setState('info.connection', true, true);\n                }\n                else{\n                    this.setState('info.connection', false, true);\n                }\n                for(const meter of meters) {\n                    await getMeterValue(meter);\n                    await this.sleep(100);\n                }\n            } catch(e: any){\n            } finally {\n                setImmediate(() => {\n                    getMetersValue(metersIdList);\n                })\n            }\n        }\n        getMetersValue(metersIdList);\n    }\n\n    private async onUnload(callback: () => void): Promise<void> {\n        try {\n            this.log.debug('vor schlie\u00DFen:'+String(this.client.isOpen))\n            await this.client.close(callback);\n            this.log.debug('nach schlie\u00DFen:'+String(this.client.isOpen))\n            callback();\n        } catch (e) {\n            callback();\n        }\n    }\n\n\n    private onStateChange(id: string, state: ioBroker.State | null | undefined): void {\n        if (state) {\n            this.log.info(`state ${id} changed: ${state.val} (ack = ${state.ack})`);\n        } else {\n            this.log.info(`state ${id} deleted`);\n        }\n    }\n}\n\nif (require.main !== module) {\n    module.exports = (options: Partial<utils.AdapterOptions> | undefined) => new WrGoodweMt(options);\n} else {\n    (() => new WrGoodweMt())();\n}"],
  "mappings": "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",
  "names": ["ModbusRTU"]
}
